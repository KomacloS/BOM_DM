{% extends 'base.html' %}
{% block content %}
<style>
@media(max-width:640px){
  #toast{bottom:6rem;}
}
</style>
<script>const MAX_DS_MB={{ max_ds_mb }};</script>
<h1 class="text-2xl mb-4">Customer Workflow</h1>
<div id="step-1" class="mb-4">
  <h2 class="font-bold">1. Select Customer</h2>
  <select id="customer-select" class="border"></select>
  <input type="text" id="new-customer-name" placeholder="New customer" class="border" />
  <input type="text" id="new-customer-contact" placeholder="Contact" class="border" />
  <button id="add-customer" class="bg-blue-500 text-white px-2">Add</button>
</div>
<div id="step-2" class="mb-4 hidden">
  <h2 class="font-bold">2. Select Project</h2>
  <select id="project-select" class="border"></select>
  <input type="text" id="new-project-name" placeholder="New project" class="border" />
  <input type="text" id="new-project-desc" placeholder="Description" class="border" />
  <button id="add-project" class="bg-blue-500 text-white px-2">Add</button>
</div>
<div id="step-3" class="mb-4 hidden">
  <h2 class="font-bold">3. Upload BOM</h2>
  <input type="file" id="bom-file" accept=".csv,.xlsx" class="border" />
  <button id="upload-bom" class="bg-blue-500 text-white px-2">Upload</button>
</div>
<div id="step-4" class="mb-4 hidden">
  <h2 class="font-bold">4. Review</h2>
  <table class="min-w-full"><thead><tr><th>Part</th><th>Description</th><th>Qty</th><th>Ref</th><th>DS</th></tr></thead><tbody id="bom-table"></tbody></table>
  <div id="pagination" class="mt-2 flex items-center space-x-2">
    <button id="prev-page" class="border px-2">Prev</button>
    <span id="page-info"></span>
    <button id="next-page" class="border px-2">Next</button>
  </div>
  <div id="toast" class="fixed bottom-4 right-4 hidden bg-green-600 text-white px-2 py-1 rounded">Saved!</div>
  <button id="save-bom" class="bg-blue-500 text-white px-2 mt-2">Save BOM</button>
  <button id="cancel-bom" class="bg-gray-500 text-white px-2 mt-2">Cancel</button>
</div>
<script>
async function loadCustomers(){
  const r=await fetch('/ui/workflow/customers');
  const data=await r.json();
  const sel=document.getElementById('customer-select');
  sel.innerHTML='<option value="">--select--</option>';
  data.forEach(c=>{const o=document.createElement('option');o.value=c.id;o.textContent=c.name;sel.appendChild(o);});
}

document.getElementById('add-customer').onclick=async ()=>{
  const name=document.getElementById('new-customer-name').value;
  const contact=document.getElementById('new-customer-contact').value;
  if(!name) return;
  await fetch('/ui/workflow/customers',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,contact})});
  loadCustomers();
};

document.getElementById('customer-select').onchange=()=>{
  const cid=document.getElementById('customer-select').value;
  if(cid){document.getElementById('step-2').classList.remove('hidden');loadProjects(cid);}
};

async function loadProjects(cid){
  const r=await fetch('/ui/workflow/projects?customer_id='+cid);
  const data=await r.json();
  const sel=document.getElementById('project-select');
  sel.innerHTML='<option value="">--select--</option>';
  data.forEach(p=>{const o=document.createElement('option');o.value=p.id;o.textContent=p.name;sel.appendChild(o);});
}

document.getElementById('add-project').onclick=async ()=>{
  const cid=document.getElementById('customer-select').value;
  const name=document.getElementById('new-project-name').value;
  const description=document.getElementById('new-project-desc').value;
  if(!cid || !name) return;
  await fetch('/ui/workflow/projects',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({customer_id:cid,name,description})});
  loadProjects(cid);
};
document.getElementById("project-select").onchange=async()=>{
  const pid=document.getElementById("project-select").value;
  if(!pid) return;
  document.getElementById("step-3").classList.remove("hidden");
  const r=await fetch(`/projects/${pid}/bom?limit=1000`);
  const data=await r.json();
  if(data.length && confirm("Edit existing BOM?")){
    items=data;
    page=0;
    renderPage();
    document.getElementById("step-4").classList.remove("hidden");
  }
};

let items=[];
let page=0;
const pageSize=10;

function showToast(msg="Saved!", ok=true){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.className=`fixed bottom-4 right-4 ${ok?"bg-green-600":"bg-red-600"} text-white px-2 py-1 rounded`;
  t.classList.remove("hidden");
  setTimeout(()=>t.classList.add("hidden"),1500);
}
function triggerUpload(id,idx){
  const input=document.createElement('input');
  input.type='file';
  input.onchange=async()=>{
    const f=input.files[0];
    if(!f) return;
    const fd=new FormData();fd.append('file',f);
    const r=await fetch(`/bom/items/${id}/datasheet`,{method:'POST',body:fd});
    if(r.ok){
      items[idx]=await r.json();
      showToast();
      renderPage();
    }else if(r.status===413){
      showToast(`Too large (max ${MAX_DS_MB} MB)`,false);
    }else{
      showToast("Error",false);
    }
  };
  input.click();
}

async function patchField(idx,field,value){
  const item=items[idx];
  if(!item.id){item[field]=value;return;}
  const body={};
  body[field]=field==="quantity"?parseInt(value,10)||1:value||null;
  const r=await fetch(`/bom/items/${item.id}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
  if(r.ok){
    items[idx]=await r.json();
    showToast();
  }else{
    showToast("Error",false);
  }
}
async function deleteRow(idx){
  const item=items[idx];
  if(item.id){
    const r=await fetch(`/bom/items/${item.id}`,{method:"DELETE"});
    if(r.status!==204){
      showToast("Error",false);
      return;
    }
  }
  items.splice(idx,1);
  if(page>0 && page*pageSize>=items.length) page--;
  renderPage();
  showToast("Deleted");
}


function renderPage(){
  const tbody=document.getElementById('bom-table');
  tbody.innerHTML='';
  const slice=items.slice(page*pageSize,(page+1)*pageSize);
  slice.forEach((row,idx)=>{
    const realIdx=page*pageSize+idx;
    const tr=document.createElement('tr');
    ['part_number','description','quantity','reference'].forEach(k=>{
      const td=document.createElement('td');
      const inp=document.createElement('input');
      inp.value=row[k]||'';inp.className='border w-full';
      if(k==='quantity') inp.type='number';
      inp.onblur=()=>patchField(realIdx,k,inp.value);
      td.appendChild(inp);tr.appendChild(td);
    const td=document.createElement('td');
    if(row.datasheet_url){
      const a=document.createElement('a');
      a.textContent='ðŸ“Ž';
      a.href=row.datasheet_url;
      a.target='_blank';
      td.appendChild(a);
    }else{
      const btn=document.createElement('button');
      btn.textContent='Upload';
      btn.id=`upload-ds-btn-${realIdx}`;
      btn.onclick=()=>triggerUpload(row.id,realIdx);
      td.appendChild(btn);
    }
    tr.appendChild(td);
    const deltd=document.createElement("td");
    const delbtn=document.createElement("button");
    delbtn.textContent="ðŸ—‘";
    delbtn.onclick=()=>deleteRow(realIdx);
    deltd.appendChild(delbtn);
    tr.appendChild(deltd);
    tbody.appendChild(tr);
  });
  const pages=Math.ceil(items.length/pageSize)||1;
  document.getElementById('page-info').textContent=`Page ${page+1} of ${pages}`;
  document.getElementById('prev-page').disabled=page===0;
  document.getElementById('next-page').disabled=page>=pages-1;
}

document.getElementById('upload-bom').onclick=async ()=>{
  const f=document.getElementById('bom-file').files[0];
  if(!f) return;
  const fd=new FormData();fd.append('file',f);
  const r=await fetch('/ui/workflow/upload',{method:'POST',body:fd});
  const data=await r.json();
  items=data;
  page=0;
  renderPage();
  document.getElementById('step-4').classList.remove('hidden');
};

document.getElementById('prev-page').onclick=()=>{if(page>0){page--;renderPage();}};
document.getElementById("go-page").onclick=()=>{
  const v=parseInt(document.getElementById("page-jump").value,10);
  const pages=Math.ceil(items.length/pageSize)||1;
  if(v>=1 && v<=pages){
    page=v-1;
    renderPage();
  }
};
document.getElementById('next-page').onclick=()=>{const pages=Math.ceil(items.length/pageSize);if(page<pages-1){page++;renderPage();}};

document.getElementById('save-bom').onclick=async ()=>{
  const project=document.getElementById('project-select').value;
  const rows=document.querySelectorAll('#bom-table tr');
  const payload=[];
  rows.forEach(tr=>{
    const i=tr.querySelectorAll('input');
    payload.push({part_number:i[0].value,description:i[1].value,quantity:parseInt(i[2].value,10)||1,reference:i[3].value||null});
  });
  const resp=await fetch('/ui/workflow/save',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({project_id:parseInt(project),items:payload})});
  if(resp.ok){
    items=await resp.json();
    renderPage();
    showToast();
  }
};

document.getElementById('cancel-bom').onclick=()=>{window.location='/ui/workflow/';};

loadCustomers();
</script>
{% endblock %}
